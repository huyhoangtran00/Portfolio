# Đây là cấu hình cho dịch vụ 'nginx' chính của bạn (được đặt tên là 'nginx-proxy' trong docker-compose.yml)
# Đường dẫn file: ./nginx/nginx.conf

events {
    worker_connections  1024; # Số lượng kết nối tối đa mà worker process có thể xử lý
}

http {
    include /etc/nginx/mime.types; # Bao gồm các loại MIME cơ bản
    default_type application/octet-stream; # Loại MIME mặc định

    sendfile on; # Tối ưu hóa việc truyền file
    keepalive_timeout 65; # Thời gian giữ kết nối

    # Định nghĩa upstream cho dịch vụ React Frontend
    # 'frontend' là tên dịch vụ trong docker-compose.yml của bạn.
    # Nginx trong container 'frontend' đang lắng nghe trên cổng 80.
    upstream frontend_service {
        server frontend:80;
    }

    # Định nghĩa upstream cho dịch vụ FastAPI Backend
    # 'backend' là tên dịch vụ trong docker-compose.yml của bạn.
    # Ứng dụng FastAPI của bạn được expose trên cổng 8000.
    upstream backend_service {
        server backend:8000;
    }

    server {
        listen 80; # Nginx này sẽ lắng nghe trên cổng 80 bên trong container (được map ra cổng 46000 bên ngoài)
        server_name localhost; # Hoặc tên miền thực tế của bạn nếu có

        # Proxy các yêu cầu API đến backend FastAPI
        # Ví dụ: khi trình duyệt gửi yêu cầu tới http://yourdomain.com/api/users,
        # Nginx sẽ chuyển tiếp yêu cầu đó đến dịch vụ FastAPI của bạn.
        location /api/ {
            proxy_pass http://backend_service/; # Sử dụng upstream đã định nghĩa
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Phục vụ ứng dụng React frontend cho tất cả các yêu cầu còn lại
        # Ví dụ: khi trình duyệt gửi yêu cầu tới http://yourdomain.com/,
        # Nginx sẽ chuyển tiếp yêu cầu đó đến dịch vụ frontend của bạn.
        location / {
            proxy_pass http://frontend_service/; # Sử dụng upstream đã định nghĩa
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}